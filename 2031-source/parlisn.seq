; ; ; LISTENA SEI ;NO INTERRUPTS LDA #%00000010 ;SET NRFD ORA PB ;TRUE STA PB ;ON BUSLE969 BIT PB ;GET BUS STATUS BMI LE998 ;IF ATN, SERVICE THAT BVS LE969 ;IF DAV FALSE, WAIT FOR IT TO GO TRUE JSR FNDWCH ;GET BUFFER NUMBER IN X BCS LE97A ;IF NO BUFFER AVAILABLE LDA CHNRDY,X ;ELSE ROR A BCS ATN122LE97A LDA ORGSA ;TEST IF CLOSE AND #$F0 CMP #$F0 BEQ ATN122 LDA SA ;GET SECONDAY ADDRESS CMP #$01 ;IF SAVING BEQ LE99BLE988 BIT PB ;ELSE GET BUS STATUS BMI LE998 ;WAIT FOR ATN FALSE BVC LE988 ;AND DAV TRUE LDA #%11111011 ;SET NDAC FALSE AND PB ;ON BUS STA PB ;AND RTS ;EXIT;LE998 JMP ATNSRV ;SERVICE ATN;LE99B SEI LDA #%11111101 ;NRFD FALSE AND PB STA PB LDA #%00000100 ;NDAC TRUE ORA PB STA PBLE9AC BIT PB BMI LE998 ;IF ATN, GO SERVICE BVC LE9AC ;IF NO DAV, WAIT FOR ATN LDA PB ;IF DAV, GET PORT DATA AND #%11111011 ;SET NDAC STA PB ;FALSE LDA #%00000010 ;SET NRFD TRUE ORA PB ;SET STA PB ;PORTLE9C3 BIT PB ;IF ATN BMI LE998 ;GO SERVICE BVC LE9C3 ;IF NO DAV, WAIT FOR ATN JMP LE99B ;ELSE LOOP;ATN122 LDA #%11111101 ;SET AND PB ;NRFD TRUE STA PB ;ON BUS AND #%00001000 ;GET EOI STA EOIFLG ;STORE STATUS LDA PA1 ;GET BUS DATA EOR #$FF ;INVERT IT STA DATA ;AND STORE BYTE SEI ;NO INTERRUPTS LDA #%00000100 ;SET ORA PB ;NDAC TRUE STA PB ;ON BUSLE9E9 BIT PB ;IF ATN BMI LE998 ;GO SERVICE THAT BVC LE9E9 ;IF NO DAV, WAIT FOR ATN LDA #%11111011 ;ELSE SET AND PB ;NDAC FALSE STA PB ;ON BUS CLI ;ALLOW INTERRUPTS JSR PUT ;BUT RECEIVED BYTE IN CHANNEL JMP LISTENA;ILERR LDA #%01001000 ORA PB STA PB JMP IDLE;; .END